# SK150C Kit 硬件指南

本文档提供 SK150C Kit 项目的硬件信息和引脚接线说明，面向硬件工程师。

## 1. MCU 硬件概述

### 1.1 主控芯片

| 参数 | 规格 |
|------|------|
| **型号** | STM32G431CBU6 |
| **架构** | ARM Cortex-M4 |
| **封装** | UFQFPN48 (7×7mm) |
| **Flash** | 128KB |
| **SRAM** | 32KB |
| **工作频率** | 最高 170MHz |
| **工作电压** | 1.71V - 3.6V |

### 1.2 时钟配置

| 时钟域 | 频率 |
|--------|------|
| **系统时钟 (SYSCLK)** | 16MHz |
| **AHB 时钟** | 16MHz |
| **APB1 时钟** | 16MHz |
| **APB2 时钟** | 16MHz |
| **USB 时钟** | 48MHz |
| **PLL 输出** | 96MHz |

### 1.3 主要功能特性

- **USB PD 支持**: 通过 UCPD1 接口实现 USB Power Delivery 协议
- **多路 ADC**: 双 ADC 支持电压、电流、温度监测
- **PWM 输出**: 多路 PWM 用于 LED 控制和风扇控制
- **调试接口**: SWD 调试 + UART 串口输出
- **GPIO 控制**: 电源使能控制和状态指示

## 2. MCU 引脚映射

### 2.1 ADC 监测模块

| 引脚 | 功能 | ADC 通道 | 用途 | 备注 |
|------|------|----------|------|------|
| **PA0** | VOUT_SN | ADC1_IN1 | 输出电压检测 | 分压比例: 14:1 |
| **PA1** | VIN_SN | ADC2_IN2 | 输入电压检测 | 分压比例: 14:1 |
| **PB0** | NTC_SN | ADC1_IN15 | 温度检测 | NTC 热敏电阻 |

**PA0/PA1 分压电阻配置：**

- **上拉电阻 (Rp)**: 130kΩ
- **下拉电阻 (Rd)**: 10kΩ
- **分压比例**: (Rp + Rd) / Rd = (130kΩ + 10kΩ) / 10kΩ = 14:1

**ADC 参考电压**: 3.0V
**采样时间**: 640.5 个时钟周期
**分辨率**: 12位
**过采样**: 256倍，右移4位

### 2.2 电源控制模块

| 引脚 | 功能 | 类型 | 用途 | 电平 |
|------|------|------|------|------|
| **PA15** | VIN_EN | GPIO_Output | 输入电压使能控制 | 高电平导通，低电平关断 |
| **PB7** | VBUS_EN | GPIO_Output | VBUS 控制使能 | 高电平有效 |

### 2.3 USB PD 接口

| 引脚 | 功能 | 接口 | 用途 | 备注 |
|------|------|------|------|------|
| **PA9** | UCPD1_DBCC1 | UCPD1 | Dead Battery CC1 | USB PD 协议 |
| **PA10** | UCPD1_DBCC2 | UCPD1 | Dead Battery CC2 | USB PD 协议 |
| **PB4** | UCPD1_CC2 | UCPD1 | USB PD CC2 通信 | 配置检测和通信 |
| **PB6** | UCPD1_CC1 | UCPD1 | USB PD CC1 通信 | 配置检测和通信 |
| **PA11** | USB_DM | USB | USB 数据负 | USB 2.0 FS |
| **PA12** | USB_DP | USB | USB 数据正 | USB 2.0 FS |

### 2.4 PWM/LED 控制

| 引脚 | 功能 | 定时器 | 用途 | 频率 | 控制方式 |
|------|------|---------|------|------|----------|
| **PA8** | POWER_LED | TIM1_CH1 | 电源状态 LED | 2kHz | PWM 呼吸灯效果 |
| **PB5** | VBUS_LED | TIM17_CH1 | VBUS 状态 LED | PWM | PWM 调光 |
| **PA5** | FAN_PWM | TIM2_CH1 | 风扇 PWM 控制 | 25kHz | PWM 调速 |
| **PB10** | FAN_PWM2 | TIM2_CH3 | 风扇 PWM 控制 2 | 25kHz | PWM 调速 |

**LED 控制说明**：

- **POWER_LED (PA8)**: 使用 PWM 呼吸灯效果，在待机模式下以渐变方式闪烁
- **LED 驱动方式**: 开漏输出，100% 占空比对应 LED 熄灭，0% 占空比对应 LED 最亮

### 2.5 输入检测

| 引脚 | 功能 | 类型 | 用途 | 触发方式 |
|------|------|------|------|----------|
| **PA6** | FAN_TOUCH | TIM3_CH1 | 风扇转速检测 | 输入捕获 |
| **PB8** | POWER_KEY | GPIO_Input | 电源按键输入 | GPIO 输入，高电平有效 |

**按键功能说明**：

- **消抖时间**: 50ms（小于50ms的按压被忽略）
- **短按**: 50ms - 1s（切换电源状态）
- **长按**: 1s - 3s（特殊功能，如重置或配置）
- **超长按**: 超过3s（忽略，防止误操作）
- **按键类型**: 上拉输入，高电平有效

### 2.6 调试接口

| 引脚 | 功能 | 接口 | 用途 | 备注 |
|------|------|------|------|------|
| **PA13** | SWD_IO | SWD | 调试数据 | ST-Link 连接 |
| **PA14** | SWD_CLK | SWD | 调试时钟 | ST-Link 连接 |
| **PA2** | USART2_TX | UART | 串口发送 | 调试输出 |
| **PA3** | USART2_RX | UART | 串口接收 | 调试输入 |

**UART 配置**: 115200 bps, 8N1

### 2.7 未使用引脚

以下引脚在当前设计中未使用，可用于扩展功能：

| 引脚 | 可用功能 | 备注 |
|------|----------|------|
| **PB1** | ADC/GPIO | 可用于额外 ADC 输入 |
| **PB9** | I2C1_SDA/GPIO | 可用于 I2C 扩展 |

## 3. 功能模块连接说明

### 3.1 电压监测电路

```text
VIN/VOUT ──[分压电阻]── ADC 输入引脚 ── MCU
            (14:1)       (PA0/PA1)
```

- **分压比例**: 14:1 (130kΩ + 10kΩ) / 10kΩ
- **最大输入电压**: 42V (对应 ADC 满量程 3.0V)
- **分辨率**: 约 10.3mV/LSB

### 3.2 温度监测电路

```text
NTC 热敏电阻 ── 分压电路 ── ADC 输入 ── MCU
                          (PB0)
```

### 3.3 USB PD 连接

```text
USB-C 连接器
├── CC1 ── PB6 (UCPD1_CC1)
├── CC2 ── PB4 (UCPD1_CC2)
├── D+ ── PA12 (USB_DP)
└── D- ── PA11 (USB_DM)
```

## 4. 系统行为说明

### 4.1 电源状态管理

系统具有两种主要工作状态：

#### 4.1.1 待机状态 (Standby)

- **输入电压使能**: PA15 输出低电平（关断）
- **LED 状态**: PA8 PWM 呼吸灯效果（渐变闪烁）
- **功耗**: 最低功耗模式
- **触发条件**: 系统启动默认状态，或短按按键从工作状态切换

#### 4.1.2 工作状态 (Working)

- **输入电压使能**: PA15 输出高电平（导通）
- **LED 状态**: PA8 LED 熄灭（PWM 占空比 0%）
- **功耗**: 正常工作功耗
- **触发条件**: 短按按键从待机状态切换

### 4.2 按键交互逻辑

| 按键操作 | 时间范围 | 系统响应 | 备注 |
|----------|----------|----------|------|
| **消抖** | < 50ms | 忽略 | 防止机械抖动 |
| **短按** | 50ms - 1s | 切换电源状态 | 待机 ↔ 工作 |
| **长按** | 1s - 3s | 特殊功能 | 预留扩展功能 |
| **超长按** | > 3s | 忽略 | 防止误操作 |

### 4.3 LED 呼吸灯效果

**实现方式**:

- 使用 TIM1_CH1 (PA8) 产生 2kHz PWM 信号
- 通过软件算法控制占空比变化，实现呼吸效果
- 开漏输出：100% 占空比 = LED 熄灭，0% 占空比 = LED 最亮

**呼吸周期**: 约 2-3 秒一个完整周期（渐亮 → 渐暗）

## 5. 电气特性

### 5.1 GPIO 特性

| 参数 | 最小值 | 典型值 | 最大值 | 单位 |
|------|--------|--------|--------|------|
| **输出高电平** | VDD-0.4 | VDD | VDD | V |
| **输出低电平** | 0 | 0 | 0.4 | V |
| **输入高电平** | 0.7×VDD | - | VDD | V |
| **输入低电平** | 0 | - | 0.3×VDD | V |
| **输出驱动能力** | - | 8 | 25 | mA |

### 5.2 ADC 特性

| 参数 | 值 | 单位 |
|------|----|----- |
| **分辨率** | 12 | bit |
| **参考电压** | 3.0 | V |
| **转换时间** | 2.5 | μs |
| **精度** | ±1 | LSB |
